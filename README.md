# cub3D

# 👉텍스쳐 표현하기

---

### 1-1

- 우선, 단순한 색상의 텍스쳐 먼저 표현해 본다.
- xpm파일을 가져오는 것이 아닌, 특정 패턴이 있는 텍스쳐를 적용시켜 본다.
- 그 원리는 다음과 같다.
    - 텍스쳐의 색상을 담고있는 int형 이중 배열 texture를 선언한다.
    - 배열의 가로줄은 동, 서, 남, 북을 판별하는 숫자이다.
    - 배열의 세로줄은 각 방위별로 어느 지점(좌표)에 색을 입힐지? 저장해 놓는다.
    - 그 후, 실제로 3D를 그릴 때 특정 좌표에 해당하는 점을 미리 저장해 놓은 색상과 매치시켜 그려준다.
    - 따라서, 수직선을 그려주는 함수를 새로 만들어 주어야 한다.
        - 그 이유는, 점을 찍을 때 마다 색상을 조회하여 그에 맞게 대입시켜주어야 하기 때문이다

---

### 1-2

- Laycasting을 하고 나서의 산출물은 다음과 같다.
    - 현재 위치와 벽 까지의 거리
    - 부딫힌 벽의 좌표.
        - ✅위의 두 가지 산출물을 가지고 texture를 표현하려면 어떻게 해야될까? → 거리 및 좌표로 계산할 수 있다. (1-4 참조)

---

### 1-3

- 그리기 위해서는 시야각을 가지고 일일히 광선을 쏴주어야 한다.
- 즉, 레이캐스팅을 시야각 만큼 실행해주어야 한다.
- 따라서, 각각의 거리가 반드시 나오게 되어있다.
- 그 거리를 가지고 지금까지 3d로 표현한 것이다.
- 지금까지 사용했던 make_line함수는 수직선 뿐만 아니라, 대각선도 그릴 수 있다. (DDA 알고리즘을 사용하여)
- ❓그렇다면, 수직선을 그리기 위해서 DDA알고리즘을 사용하지 않을 방법이 있을 까?
    - texture 예제 02_textured_raycast.c를 보면 다음과 같이 설명한다.
    - 모든 창의 픽셀(1000 * 1000)을 돌면서 해당 좌표에 색깔을 입혀준다.
    - 그 색깔을 buf로 부터 왔다.
    - ❓그렇다면, buf에 들어가있는 색깔은 천장과 바닥, 그리고 벽까지 모두 가지고 있는 것인가? 그리고, 그게 천장, 바닥, 벽인지 어떻게 알지?
    - buf는 만약 해상도가 1920 * 1080이라면, buf[1080][1920]까지 가지고 있다.
        - ✅그 할당은 또 어디서 하지? 👉(init)
        - ❌buf는 당장은 필요 없는 것 같다. 아직 할당하지는 말자.

---

### 1-4

- texture 변수의 두 번째 texture[][here] 인자 here 는 0부터 width * height 의 범위를 가질 수 있다.
- ✅그렇다면, 천장이나 바닥도 위의 텍스쳐 규칙에 따라 색상을 가질 가능성이 있는데, 검은색으로 나올 수 있는 이유는? → 검은색으로 나오는 것은 맨 처음에 buf의 모든 값들을 0으로 초기화 해주어서 이고, 벽의 색상이 나오는 것은 buf에 넣을 때 color를 drawstart 부터 drawEnd까지 넣어주기 때문이다.

    ```c
    drawStart = height / 2 - lineheight / 2
    drawEnd = height / 2 + lineheight / 2
    // y좌표의 시작과 끝
    // x좌표는 당연하게도, 시야각의 반복문을 돌고있기 때문에 내가 쓰고있는 코드의 i라고 할 수 있음.
    ```

- buf는 또 하나의 image라고 할 수 있다. (표현만 안할 뿐, 색상만 담고있는 이미지)

---

### 1-5

- 전체적으로 텍스쳐를 표현하는 방법의 과정을 적어본다.
- 우선, 색상정보(≓방정식, 왜냐하면 하나의 텍스쳐 안에서도 색상은 나뉘기 때문이다.)를 각 방위 (동, 서, 남, 북)별로 저장하기 위해서 int형 이중포인터 texture를 선언한다.
- 배열의 첫번째 요소는 방위를 결정하고, 두 번째 요소는 색상을 저장할  texture의 총 크기이다. (texwidth, texheight) → 💡즉, 얼마나 정밀하게 표현할지 결정한다. 조건을 많이 넣어주면 정밀하게 표현할 수 있다. 일단 나도 64로 해두는 것이 좋겠다.
- 색상을 임시로 담을 buf 변수를 선언한다. 그 이유는, 색상을 한번에 담았다가 한번에 출력해주기 위함이다. ❓시야각을 도는 사이에 색상을 넣어도 되지않나?
- texture변수는 마트, buf는 소비자라고 생각하면 편하다. 모든 색상을 가지고 있는 texture에서 buf라는 소비자가 필요한 색상을 뽑아간다고 생각하면 된다.
- 필요한 색상을 전부 뽑아갔으면 색을 그려준다.
- 이 과정이 mlx_loop를 한번 돌 때마다 모두 이루어져야 한다.

---

### 1-6

- 내가 위 알고리즘을 실행하기 위해 먼저 해야할 것

✅방위별로 상수를 지정해준다. 동 - 0 서 - 1 남 - 2 북 - 3

- 방위를 판별하는 함수를 만들어준다. 방위는 매번 확인하기 때문에, 변수 하나로 설정해도 관계없다.
- game→wall.cardinal 변수를 하나 만들어주자.

✅texture의 가로, 세로 상수를 지정해준다. 64 * 64로 일단 해 보자.

✅texture 변수, buf변수 생성

- texture변수의 경우 texturesize 가 상수로 정해져있기 때문에 따로 malloc은 하지 않아도 될듯
- buf변수는 창의 크기가 가변적이므로 malloc하는 함수가 따로 필요할 것 같음.

✅texture 배열에 색상을 넣는 과정이 필요하다. set_texture() 최초 한번만 실행한다.

📌buf배열에 색상을 쇼핑하는 함수가 필요하다. 이건 매번 실행한다.

- 쇼핑하고 색을 등록하는 절차를 한 함수에 작성한다면?

❓쇼핑해 온 색상을 표현하는 과정이 필요하다. 근데 이 과정은 안해도 될것같긴한데.. 어차피 선을 그리는 함수도 색만 바꾸어 주는거라..

---

### 2-1

### 시행착오

- 첫 번째 트라이
    - 일단 컴파일 완료, 시작하자마자 segmentation fault 뜨면서 꺼졌음
    - 대신, 순간 텍스쳐가 입혀진 벽들이 보였음. 하늘의 구현은 되었으나 바닥은 되었는지 모르겠음.
        - ✅바닥, 천장
        - ✅구조물의 형태
        - ✅북, 동, 남 확인
        - ✅구조물의 텍스쳐 (깨짐) → (3-6)
        - 위 결과로 미루어보아, 텍스쳐 자체는 texture 변수에 잘 대입이 되었지만, 불러오는 과정에서 약간의 공식을 수정해주면 될 듯
    - 💡텍스쳐들이 조각조각 깨져있었음. 아마 공식을 잘못 대입해서가 아닐까?
    - 만약 color를 삽입하는게 잘못되었다면 구조물의 형태가 제대로 출력되지 않았을 것이다.
    - 따라서, color를 받아오는 과정에서 문제가 생겼을 것으로 추측된다.
    - texNum (방위) 를 확인해본 결과 -1값이 나오지 않은 것으로 보아 이 값에서 seg fault가 뜬 건 아니다.
    - 우연히, printf를 실행해보니 꺼지지 않고 잘 실행되어 그 결과를 캡쳐해 두었다.

    ![cub3D%20676852cad05841448382f6325d7cff88/_2020-08-08__5.15.02.png](cub3D%20676852cad05841448382f6325d7cff88/_2020-08-08__5.15.02.png)

    - 코드를 일일히 확인해 본 결과, 색상을 받아오는 과정에서 문제가 생긴 것이 아닌, 색상을 집어 넣는 과정인 shopping_draw의 game→img.data[to_coord()] = color 이 부분에서 문제가 생긴 것을 확인하였다.
        - y값이 double 이어서 그런가 ? → int로 바꾸었는데도 튕김
        - 의문점 : 첫 색상은 잘 출력 되다가, 갑자기 튕긴다? 뭔가 다시 그리게 되면 충돌이 일어나는 건가?
            - 하지만, make_line도 마찬가지로 좌표를 그리기만 하지, 다시 그리게 되는 경우는 생각하지 않는다.
            - ✅y의 값이 음수가 나올 경우, 이상한 배열에 진입할 수 있다. 따라서 그에대한 예외처리를 해주었다.
            - ❓지금 표현하는 텍스쳐가 과연 올바른 텍스쳐일까? (서쪽을 보면 제대로 된 것 같기도...)
            - ❓왜 make_line에서는 음수처리를 따로 해주지 않았는데도 잘 됐으면서, 이 코드에서만 오류가 생긴 것일까? (대입부분에서 생긴 오류가 확실함) → (3-7)과 관련.
            - yohlee 님의 코드에서는 정상적으로 빨간색 격자 벽과, 노란색 벽이 출력 되는 모습을 확인할 수 있음
                - 여기서 두 가지 케이스로 나누어 볼 수 있음
                - texture 공식을 잘못 대입했거나, → 코드 비교상, 차이는 없었음.
                - texture를 받아올 때 잘못 받아왔거나. → 이것이라고 추측하고 코드 작성 gogo

---

### 2-2

### 시행착오2

- 위 2-1에서 texture를 받아올 때 texY와 texX를 잘 못 받아와서 색상을 이상하게 출력하는 것이라 생각하였음
- 그래서, 다음과 같이 임의로 texY와 texX를 수정해 보았음.
- 다음과 같이 비례식을 사용함.
    - 전체 x 길이 : 가리키는 x좌표 = TEX 의 x 길이 : texX
    - 전체 y 길이: 가리키는 y좌표 = TEX의 y 길이 : texY
- 그랬더니 다음과 같이 결과가 나옴

![cub3D%20676852cad05841448382f6325d7cff88/_2020-08-08__7.29.10.png](cub3D%20676852cad05841448382f6325d7cff88/_2020-08-08__7.29.10.png)

- 이는 전체 맵에 대해서 해당 texture에 대한 부분만 표현할 뿐, 타일별로 텍스쳐가 나뉘지 않았음. (하나로 보임.) 다시 말해, 왼쪽에 보이는 쿠키모양의 타일은 북쪽 텍스쳐에서 왼쪽 부분에 해당한다는 것임.
- ✅그렇다면, 타일별로 출력하려면 어떻게 해야만 할까? → 3-6
- vector 기반으로 만들어진 코드로 따라치기엔 한계가 있음.
- 따라서, pikuma 기반으로 영상을 바탕으로 만들어보자.
    - ❌pikuma 영상에는 텍스쳐 구현이 존재하지 않는다.

---

### 2-3

### 시행착오 3

- 벽에 부딫히는 x좌표와 y좌표에 따라 그 비율로 texture의 좌표를 정해주었음
- 그 결과는 다음과 같다.

![cub3D%20676852cad05841448382f6325d7cff88/_2020-08-08__9.56.41.png](cub3D%20676852cad05841448382f6325d7cff88/_2020-08-08__9.56.41.png)

- 일단, 거리에 따라 텍스쳐가 바뀌는 현상은 사라졌지만, 초 근거리로 갈경우 왜곡이 생기고 텍스쳐의 모양 또한 정상적이지 않음.
- ✅따라서, 다음 시간에는 직접 xpm파일을 이미지화 하여 받아오고, 그 이미지 배열을 토대로 다시한번 짜보자. → (3-6)

---

### 3-1

### 텍스쳐 파일(XPM) 생성하기

- 우선, 그리고 싶은 이미지를 찾는다.
- 사이즈는 상관 없지만, 최대한 64 * 64 형식을 맞추는 것이 좋다.
- 만약 64 * 64 보다 더 큰 파일을 읽어올 경우, TEX_WIDTH와 TEX_HEIGHT를 바꾸어주면 된다.
- 또, 사이즈 변환 사이트 ([https://www.iloveimg.com/ko](https://www.iloveimg.com/ko)) 와 파일 변환 사이트 ([https://convertio.co/kr/](https://convertio.co/kr/)) 를 이용하여, 사이즈를 64로 맞춘 후 xpm파일로 변환시켜 주면 mlx_xpm_to_image함수로 불러들일 수 있다.

---

### 3-2

### XPM 파일의 구성

- xpm파일을 열어보면 비교적 형식이 갖추어져 있는 것을 볼 수 있는데,  한 예시를 들어보면 다음과 같다.

![cub3D%20676852cad05841448382f6325d7cff88/_2020-08-09__2.30.48.png](cub3D%20676852cad05841448382f6325d7cff88/_2020-08-09__2.30.48.png)

![cub3D%20676852cad05841448382f6325d7cff88/_2020-08-09__2.31.55.png](cub3D%20676852cad05841448382f6325d7cff88/_2020-08-09__2.31.55.png)

- 추측상, xpm파일은 c언어 기반으로 이미지를 만드는 것으로 판단된다.
- 주석에 나와있는 대로, colums는 열의 개수, rows는 행의 개수, 그리고 각각 해쉬와 비슷하다고 볼 수 있게 어떤 문자에 대한 색상을 라인별로 나타내었다.
- pixel은 특정 색상을 문자로 대치시켜 표현한 것으로 보인다. (줄 수를 세보면 64 by 64가 나온다.)

---

### 3-3

### mlx_xpm_to_image

- xpm파일을 img형식으로 바꾸어주는 함수이다.
- 이 함수를 사용하면, 이전에 시도해봤듯이 texture[][] 라는 배열에 각각에 색상이 담기게 된다.
- ✅오늘은 xpm파일을 각각 동, 서, 남, 북으로 매칭시키고, 제대로 출력시키도록 하는게 목표이다.
- ✅우선, .cub파일을 바탕으로 맵을 불러오는 작업은 나중에 map validation에서 진행하도록 하고, 지금은 파일 경로로 바로 읽어들여 그 xpm파일을 tex 구조체 안의 img[cardinal] 에 각각 담아보자.
- 그 후, 담긴 이미지들을 불러들여 벽의 색상을 제대로 나오게 해 보자.

---

### 3-4

### 시행착오 1

- 우선, xpm파일을 읽어들여 맵에 출력하는 것 성공하였음

![cub3D%20676852cad05841448382f6325d7cff88/_2020-08-09__2.58.59.png](cub3D%20676852cad05841448382f6325d7cff88/_2020-08-09__2.58.59.png)

- 다만, 전처럼 픽셀이 깨져서 보이고 (잘못 접근한 것임), 타일별로 칸이 나뉘지 않음.
- ✅오늘은 어제 끝내지 못했던 이 공식을 제대로 수정해보고, 타일이 제대로 나오도록 출력하는 것을 목표로 하자.
- ❓yohlee님의 03예제를 보면, xpm파일의 이미지를 그대로 사용하지 않고 texture 배열에 한번 넣었다가 쓰는 것을 볼 수 있다. 아마 할당해제 문제 때문일까?

---

### 3-5

### yohlee님의 코드 해석

- calc함수 → 아마 raycasting한 후, 컬러 까지 넣어주는 함수를 합친 것 같다.
- x : 0부터 width까지 도는 것으로 보아, 아마 3d를 출력하기 위한 x좌표? 인듯 하다.
- cameraX : x가 0일땐 -1, x가 width일 땐 1이다.

---

### 3-6

### 2020 08 10 (월)

- 텍스쳐 입히기 성공

![cub3D%20676852cad05841448382f6325d7cff88/_2020-08-10__2.26.06.png](cub3D%20676852cad05841448382f6325d7cff88/_2020-08-10__2.26.06.png)

- 해결 방법 : 텍스쳐의 특정 좌표를 가져오기 위해서는, 벽에 쏜 레이져가 가지고있는 좌표를 텍스쳐의 좌표로 비례식을 이용하여 바꾸어 주면 된다.
- 텍스쳐의 X 좌표 가져오는 방법.
    - 레이캐스팅의 결과가 수직선에 부딪혀서 끝났나, 수평선에 부딪혀서 끝났는지가 가장 중요하다.
    - 수평선에 부딪혀서 끝났다면, 벽에 부딪힌 좌표의 x좌표가 텍스쳐의 x좌표와 관련이 있다.
    - 수직선에 부딪혀서 끝났다면,  벽에 부딪힌 좌표의 y좌표가 텍스쳐의 x좌표와 관련이 있다.
    - 하지만 그 전에, 텍스쳐는 "타일별로" 구분되기 때문에 벽에 부딪힌 좌표가 타일 하나의 어디 부분에 해당하는지 구해야한다.
    - 내가 구한 textureX 좌표 공식은 다음과 같다.

    ```c
    // 수직선에 부딪혔다면
    if (game->wall.is_x_or_y == X_SIDE)
        texX = (int)(fmod(game->wall.y, game->tile_ysize) * TEX_HEIGHT / game->tile_ysize;
    else 
    		texX = (int)(fmod(game->wall.x, game->tile_xsize) * TEX_WIDTH / game->tile_xsize;

    // 여기서 wall.y, wall.x는 벽에 부딪힌 x, y좌표이다.
    ```

---

### 3-7

### 텍스쳐 구현 했으나 문제점

- 📌색상을 집어 넣는 코드에서 heap buffer overflow가 뜬다. 이걸 해결해야함.
- 📌해결하기에 앞서, 수직선과 수평선을 헷갈리기 쉬우므로 변수 이름 및 상수이름을 재 정의 해줄 필요가 있다.